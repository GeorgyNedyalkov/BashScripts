#!/bin/bash
#Malware scan script by GNedyalkov@NS1
#Version 1.1

#Functions

usage () {
  echo "Script usage:"
  echo "===================================================="
  echo "To scan client's account: scan account_name"
  echo "===================================================="
}

check_maldet () {
  if ! grep  -q "/home/.*/mail" /usr/local/maldetect/ignore_paths
    then
    echo "/home/.*/mail" >> /usr/local/maldetect/ignore_paths
  fi
}

#The actual script

if [ $# -eq '0' ] || [ $# -gt 1 ]
then
   usage
elif [ -d "/home/$1/" ]
then
  check_maldet
  echo "The account exists!"
  echo "/home/${1}/"
  echo "Updating maldet... Please wait..."
  maldet -d > /dev/null 2>&1
  maldet -u > /dev/null 2>&1
  echo "Maldet update has complete. Performing maldet scan in screen..."
  screen -dmS scan_${1} bash
  screen -S scan_${1} -p 0 -X exec /usr/local/cpanel/bin/cpuwatch 8 maldet -a /home/${1}/
  echo "Maldet scan for account ${1} is running in screen:"
  screen -ls|grep scan_${1}
else
  echo "Account with such name doesn't exist! Please double check!"
fi
